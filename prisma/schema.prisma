generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Route {
  routeId       Int     @id @default(autoincrement()) @map("RouteID")
  startLocation String  @map("StartLocation") @db.VarChar(100)
  endLocation   String  @map("EndLocation") @db.VarChar(100)
  distance      Decimal @map("Distance") @db.Decimal(6, 2)
  trips         Trip[]

  @@map("Route")
}

model Driver {
  driverId         Int                      @id @default(autoincrement()) @map("DriverID")
  name             String                   @map("Name") @db.VarChar(100)
  licenseNumber    String                   @unique @map("LicenseNumber") @db.VarChar(50)
  contactInfo      String?                  @map("ContactInfo") @db.VarChar(150)
  shiftAssignments DriverShiftAssignment[]
  assignment       DriverVehicleAssignment?
  trips            Trip[]

  @@map("Driver")
}

model Vehicle {
  vehicleId          Int                      @id @default(autoincrement()) @map("VehicleID")
  licensePlate       String                   @unique @map("LicensePlate") @db.VarChar(30)
  capacity           Int                      @map("Capacity")
  status             VehicleStatus            @default(active) @map("Status")
  shiftAssignments   DriverShiftAssignment[]
  assignment         DriverVehicleAssignment?
  fuelRecords        FuelRecord[]
  incidentReports    IncidentReport[]
  maintenanceRecords MaintenanceRecord[]
  scheduledMaints    ScheduledMaintenance[]
  trips              Trip[]

  @@map("Vehicle")
}

model Passenger {
  passengerId Int      @id @default(autoincrement()) @map("PassengerID")
  name        String   @map("Name") @db.VarChar(100)
  contactInfo String?  @map("ContactInfo") @db.VarChar(150)
  tickets     Ticket[]

  @@map("Passenger")
}

model UserRole {
  userId    Int          @id @default(autoincrement()) @map("UserID")
  username  String       @unique @map("Username") @db.VarChar(50)
  role      UserRoleType @default(passenger) @map("Role")
  auditLogs AuditLog[]

  @@map("UserRole")
}

model Trip {
  arrivalTime   DateTime?        @map("ArrivalTime")
  departureTime DateTime         @map("DepartureTime")
  driverId      Int              @map("DriverID")
  routeId       Int              @map("RouteID")
  tripId        Int              @id @default(autoincrement()) @map("TripID")
  vehicleId     Int              @map("VehicleID")
  price         Decimal          @default(0) @map("Price") @db.Decimal(8, 2)
  incidents     IncidentReport[]
  seats         Seat[]
  tickets       Ticket[]
  driver        Driver           @relation(fields: [driverId], references: [driverId])
  route         Route            @relation(fields: [routeId], references: [routeId])
  vehicle       Vehicle          @relation(fields: [vehicleId], references: [vehicleId])

  @@index([departureTime], map: "idx_trip_departure")
  @@index([vehicleId], map: "idx_trip_vehicle")
  @@index([driverId], map: "idx_trip_driver")
  @@map("Trip")
}

model Seat {
  seatNumber Int        @map("SeatNumber")
  status     SeatStatus @default(available) @map("Status")
  tripId     Int        @map("TripID")
  trip       Trip       @relation(fields: [tripId], references: [tripId], onDelete: Cascade)
  tickets    Ticket?

  @@id([tripId, seatNumber])
  @@index([tripId, status], map: "idx_seat_trip_status")
  @@map("Seat")
}

model Ticket {
  passengerId  Int       @map("PassengerID")
  price        Decimal   @map("Price") @db.Decimal(8, 2)
  purchaseDate DateTime  @default(now()) @map("PurchaseDate")
  seatNumber   Int       @map("SeatNumber")
  ticketId     Int       @id @default(autoincrement()) @map("TicketID")
  tripId       Int       @map("TripID")
  payment      Payment?
  passenger    Passenger @relation(fields: [passengerId], references: [passengerId])
  seat         Seat      @relation(fields: [tripId, seatNumber], references: [tripId, seatNumber])
  trip         Trip      @relation(fields: [tripId], references: [tripId])

  @@unique([tripId, seatNumber], map: "uq_trip_seat")
  @@index([tripId], map: "idx_ticket_trip")
  @@index([passengerId], map: "idx_ticket_passenger")
  @@map("Ticket")
}

model Payment {
  paymentId     Int           @id @default(autoincrement()) @map("PaymentID")
  ticketId      Int           @unique @map("TicketID")
  amount        Decimal       @map("Amount") @db.Decimal(8, 2)
  paymentMethod PaymentMethod @default(other) @map("PaymentMethod")
  paymentDate   DateTime      @default(now()) @map("PaymentDate")
  ticket        Ticket        @relation(fields: [ticketId], references: [ticketId], onDelete: Cascade)

  @@map("Payment")
}

model MaintenanceRecord {
  recordId    Int      @id @default(autoincrement()) @map("RecordID")
  vehicleId   Int      @map("VehicleID")
  date        DateTime @map("Date") @db.Date
  description String?  @map("Description")
  cost        Decimal? @map("Cost") @db.Decimal(10, 2)
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [vehicleId], onDelete: Cascade)

  @@index([vehicleId, date], map: "idx_maintenance_vehicle_date")
  @@map("MaintenanceRecord")
}

model FuelRecord {
  fuelRecordId Int      @id @default(autoincrement()) @map("FuelRecordID")
  vehicleId    Int      @map("VehicleID")
  date         DateTime @map("Date") @db.Date
  fuelAmount   Decimal  @map("FuelAmount") @db.Decimal(8, 2)
  cost         Decimal? @map("Cost") @db.Decimal(10, 2)
  vehicle      Vehicle  @relation(fields: [vehicleId], references: [vehicleId], onDelete: Cascade)

  @@index([vehicleId, date], map: "idx_fuel_vehicle_date")
  @@map("FuelRecord")
}

model ScheduledMaintenance {
  scheduleId    Int      @id @default(autoincrement()) @map("ScheduleID")
  vehicleId     Int      @map("VehicleID")
  scheduledDate DateTime @map("ScheduledDate") @db.Date
  description   String?  @map("Description")
  vehicle       Vehicle  @relation(fields: [vehicleId], references: [vehicleId], onDelete: Cascade)

  @@index([vehicleId, scheduledDate], map: "idx_sched_vehicle_date")
  @@map("ScheduledMaintenance")
}

model IncidentReport {
  incidentId   Int              @id @default(autoincrement()) @map("IncidentID")
  vehicleId    Int?             @map("VehicleID")
  tripId       Int?             @map("TripID")
  incidentDate DateTime         @map("IncidentDate")
  description  String           @map("Description")
  severity     IncidentSeverity @default(low) @map("Severity")
  trip         Trip?            @relation(fields: [tripId], references: [tripId])
  vehicle      Vehicle?         @relation(fields: [vehicleId], references: [vehicleId])

  @@index([incidentDate], map: "idx_incident_date")
  @@map("IncidentReport")
}

model AuditLog {
  logId     Int       @id @default(autoincrement()) @map("LogID")
  action    String    @map("Action") @db.VarChar(50)
  tableName String    @map("TableName") @db.VarChar(50)
  recordId  Int       @map("RecordID")
  timestamp DateTime  @default(now()) @map("Timestamp")
  userId    Int?      @map("UserID")
  details   Json?     @map("Details")
  user      UserRole? @relation(fields: [userId], references: [userId])

  @@index([timestamp], map: "idx_audit_timestamp")
  @@index([tableName, recordId], map: "idx_audit_table_record")
  @@map("AuditLog")
}

model DailySummary {
  summaryDate      DateTime @id @map("SummaryDate") @db.Date
  totalTrips       Int      @map("TotalTrips")
  totalTicketsSold Int      @map("TotalTicketsSold")
  totalRevenue     Decimal  @map("TotalRevenue") @db.Decimal(12, 2)

  @@map("DailySummary")
}

model DriverVehicleAssignment {
  assignmentId Int      @id @default(autoincrement()) @map("AssignmentID")
  driverId     Int      @unique @map("DriverID")
  vehicleId    Int      @unique @map("VehicleID")
  assignedAt   DateTime @default(now()) @map("AssignedAt") @db.Timestamp(6)
  driver       Driver   @relation(fields: [driverId], references: [driverId], onDelete: Cascade, map: "fk_assign_driver")
  vehicle      Vehicle  @relation(fields: [vehicleId], references: [vehicleId], onDelete: Cascade, map: "fk_assign_vehicle")

  @@index([driverId], map: "idx_assign_driver")
  @@index([vehicleId], map: "idx_assign_vehicle")
  @@map("DriverVehicleAssignment")
}

model DriverShiftAssignment {
  assignmentId Int        @id @default(autoincrement()) @map("AssignmentID")
  driverId     Int        @map("DriverID")
  vehicleId    Int        @map("VehicleID")
  assignDate   DateTime   @map("AssignDate") @db.Date
  shift        shift_type @map("Shift")
  assignedAt   DateTime   @default(now()) @map("AssignedAt") @db.Timestamp(6)
  unassignedAt DateTime?  @map("UnassignedAt") @db.Timestamp(6)
  driver       Driver     @relation(fields: [driverId], references: [driverId], onDelete: Cascade, map: "fk_dsa_driver")
  vehicle      Vehicle    @relation(fields: [vehicleId], references: [vehicleId], onDelete: Cascade, map: "fk_dsa_vehicle")

  @@index([assignDate, shift], map: "idx_dsa_date_shift")
  @@map("DriverShiftAssignment")
}

model DriverShiftAssignmentHistory {
  historyId     Int        @id @default(autoincrement()) @map("HistoryID")
  assignDate    DateTime   @map("AssignDate") @db.Date
  shift         shift_type @map("Shift")
  action        String     @map("Action") @db.VarChar(20)
  driverId      Int?       @map("DriverID")
  vehicleId     Int?       @map("VehicleID")
  prevDriverId  Int?       @map("PrevDriverID")
  prevVehicleId Int?       @map("PrevVehicleID")
  changedAt     DateTime   @default(now()) @map("ChangedAt") @db.Timestamp(6)
  note          String?    @map("Note")

  @@index([assignDate, shift], map: "idx_dsa_hist_date_shift")
  @@index([changedAt], map: "idx_dsa_hist_changedat")
  @@map("DriverShiftAssignmentHistory")
}

enum VehicleStatus {
  active
  inactive
  maintenance
}

enum SeatStatus {
  available
  held
  sold
}

enum UserRoleType {
  admin
  passenger
  driver
  mechanic
}

enum IncidentSeverity {
  low
  medium
  high
  critical
}

enum PaymentMethod {
  cash
  card
  mobile
  other
}

enum shift_type {
  morning
  day
  evening
  night
}
